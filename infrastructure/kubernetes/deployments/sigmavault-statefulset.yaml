---
# ΣVAULT StatefulSet Configuration
# Phase 14 Production Deployment
# Neurectomy Unified Namespace

apiVersion: v1
kind: ServiceAccount
metadata:
  name: sigmavault-sa
  namespace: neurectomy
automountServiceAccountToken: false

---
apiVersion: v1
kind: Service
metadata:
  name: sigmavault
  namespace: neurectomy
  labels:
    app: sigmavault
    component: storage
spec:
  type: ClusterIP
  clusterIP: None # Headless service for StatefulSet DNS discovery
  selector:
    app: sigmavault
  ports:
    - name: http
      port: 8002
      targetPort: 8002
      protocol: TCP
    - name: metrics
      port: 9092
      targetPort: 9092
      protocol: TCP
  sessionAffinity: None

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sigmavault
  namespace: neurectomy
  labels:
    app: sigmavault
    component: storage
spec:
  serviceName: sigmavault # Headless service for DNS
  replicas: 3
  selector:
    matchLabels:
      app: sigmavault
  template:
    metadata:
      labels:
        app: sigmavault
        component: storage
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9092"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: sigmavault-sa
      terminationGracePeriodSeconds: 60
      dnsPolicy: ClusterFirst

      # Pod Anti-Affinity: Spread across nodes and zones
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - sigmavault
                topologyKey: kubernetes.io/hostname
            - weight: 80
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - sigmavault
                topologyKey: topology.kubernetes.io/zone

        # Topology Spread Constraints
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app: sigmavault

      # Init container: Wait for ConfigMap and Secrets
      initContainers:
        - name: wait-for-config
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              echo "Waiting for ConfigMap volume mount..."
              max_retries=30
              retry_count=0
              while [ ! -f /config/COMPRESSION_WORKERS ] && [ $retry_count -lt $max_retries ]; do
                echo "Retry $retry_count/$max_retries: Waiting for /config/COMPRESSION_WORKERS..."
                sleep 1
                retry_count=$((retry_count + 1))
              done
              if [ -f /config/COMPRESSION_WORKERS ]; then
                echo "ConfigMap ready!"
                exit 0
              else
                echo "ConfigMap timeout after $max_retries seconds"
                exit 1
              fi
          volumeMounts:
            - name: config-volume
              mountPath: /config
              readOnly: true
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false

      # Main container: ΣVAULT
      containers:
        - name: sigmavault
          image: neurectomy/sigmavault:latest
          imagePullPolicy: Always

          # Ports
          ports:
            - name: http
              containerPort: 8002
              protocol: TCP
            - name: metrics
              containerPort: 9092
              protocol: TCP

          # Environment from ConfigMap (shared)
          envFrom:
            - configMapRef:
                name: neurectomy-config
            - secretRef:
                name: sigmavault-secrets

          # Environment variables
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: REPLICATION_FACTOR
              value: "3"
            - name: STORAGE_API_PORT
              value: "8002"
            - name: METRICS_PORT
              value: "9092"

          # Resources
          resources:
            requests:
              cpu: "2"
              memory: "4Gi"
              ephemeral-storage: "1Gi"
            limits:
              cpu: "4"
              memory: "8Gi"
              ephemeral-storage: "5Gi"

          # Volume mounts
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config-volume
              mountPath: /config
              readOnly: true
            - name: secrets
              mountPath: /secrets
              readOnly: true
            - name: tmp-volume
              mountPath: /tmp
            - name: cache-volume
              mountPath: /cache
            - name: mnt-sigmavault
              mountPath: /mnt/sigmavault

          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            privileged: true
            capabilities:
              add:
                - SYS_ADMIN

          # Health probes
          livenessProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /ready
              port: http
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 2

          startupProbe:
            httpGet:
              path: /health
              port: http
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 30

      # Volumes
      volumes:
        - name: config-volume
          configMap:
            name: neurectomy-config
            defaultMode: 0644
        - name: secrets
          secret:
            secretName: sigmavault-secrets
            defaultMode: 0600
        - name: tmp-volume
          emptyDir:
            sizeLimit: 1Gi
        - name: cache-volume
          emptyDir:
            sizeLimit: 2Gi
        - name: mnt-sigmavault
          emptyDir:
            sizeLimit: 5Gi

  # Volume Claim Templates for persistent storage
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: gp3
        resources:
          requests:
            storage: 1Ti

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: sigmavault-hpa
  namespace: neurectomy
  labels:
    app: sigmavault
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: sigmavault
  minReplicas: 1
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
        - type: Pods
          value: 1
          periodSeconds: 60
      selectPolicy: Min
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 1
          periodSeconds: 30
      selectPolicy: Max

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: sigmavault-pdb
  namespace: neurectomy
  labels:
    app: sigmavault
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: sigmavault

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sigmavault-network-policy
  namespace: neurectomy
  labels:
    app: sigmavault
spec:
  podSelector:
    matchLabels:
      app: sigmavault

  policyTypes:
    - Ingress
    - Egress

  # Ingress rules
  ingress:
    # Allow from other pods in neurectomy namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: neurectomy
      ports:
        - protocol: TCP
          port: 8002
        - protocol: TCP
          port: 9092

    # Allow from monitoring namespace (Prometheus)
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9092

  # Egress rules
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow communication within neurectomy namespace
    - to:
        - namespaceSelector:
            matchLabels:
              name: neurectomy
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8001
        - protocol: TCP
          port: 8002
        - protocol: TCP
          port: 8003

    # Allow HTTPS (external API calls if needed)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
